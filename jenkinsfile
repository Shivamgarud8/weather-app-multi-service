pipeline {
    agent any

    environment {
        ANSIBLE_SERVER = "ec2-user@13.50.16.229"
        APP_DIR = "/home/ubuntu/flask-weather-app"
        TARGET_IP = "13.49.49.25"
        PORT = "5000"
        INVENTORY = "/etc/ansible/playbooks/inventory.ini"
        PLAYBOOK = "/etc/ansible/playbooks/flask.yml"
        CREDENTIAL_ID = "jenkins-weather"  // Jenkins SSH credential to reach Ansible server
    }

    stages {
        stage('Run Ansible from Jenkins') {
            steps {
                sshagent(credentials: [CREDENTIAL_ID]) {
                    echo "üì¶ Triggering Ansible playbook on Ansible server..."
                    sh """
                        ssh -o StrictHostKeyChecking=no ${ANSIBLE_SERVER} 'ansible-playbook -i ${INVENTORY} ${PLAYBOOK}'
                    """
                }
            }
        }

        stage('Start Flask App on Target') {
            steps {
                sshagent(credentials: [CREDENTIAL_ID]) {
                    echo "üöÄ Starting Flask app on target server..."
                    sh """
                        ssh -o StrictHostKeyChecking=no ${ANSIBLE_SERVER} 'ssh -o StrictHostKeyChecking=no ubuntu@${TARGET_IP} "source ${APP_DIR}/venv/bin/activate && pkill gunicorn || true && nohup gunicorn -w 4 -b 0.0.0.0:${PORT} app:app > ${APP_DIR}/app.log 2>&1 &"'
                    """
                }
            }
        }

        stage('Health Check') {
            steps {
                echo "ü©∫ Checking Flask app..."
                script {
                    def result = sh(script: "curl -s -o /dev/null -w '%{http_code}' http://${TARGET_IP}:${PORT}/", returnStdout: true).trim()
                    if (result != '200') {
                        error("‚ùå Health check failed! Flask app not reachable.")
                    } else {
                        echo "‚úÖ Flask app is running on port ${PORT}."
                    }
                }
            }
        }
    }

    post {
        success {
            echo "üéâ Deployment successful! Visit: http://${TARGET_IP}:${PORT}/"
        }
        failure {
            echo "‚ùå Deployment failed. Check Jenkins logs."
        }
    }
}
