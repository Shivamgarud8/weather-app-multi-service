pipeline {
    agent any

    environment {
        ANSIBLE_SERVER = "ec2-user@13.50.16.229"
        INVENTORY = "/etc/ansible/playbooks/inventory.ini"
        PLAYBOOK = "/etc/ansible/playbooks/flask.yml"
        TARGET_IP = "51.21.196.192"
        PORT = "5000"
        CREDENTIAL_ID = "jenkins-weather"
    }

    stages {
        stage('Run Ansible') {
            steps {
                sshagent(credentials: [CREDENTIAL_ID]) {
                    sh """
                    ssh -o StrictHostKeyChecking=no ${ANSIBLE_SERVER} '
                      export ANSIBLE_HOST_KEY_CHECKING=False
                      chmod 600 /home/ec2-user/terraform.pem
                      ansible-playbook -i ${INVENTORY} ${PLAYBOOK}
                    '
                    """
                }
            }
        }

        stage('Health Check') {
            steps {
                sh "curl -f http://${TARGET_IP}:${PORT}/"
            }
        }
    }
}
